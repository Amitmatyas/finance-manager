<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מנהל כספים - מאת עמית מטיאס</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💰</text></svg>">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <!-- קונטיינר התחברות -->
    <div id="loginContainer" class="container mx-auto max-w-md bg-white rounded-xl shadow-2xl p-6">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">מנהל כספים</h1>
            <p class="text-sm text-gray-500 mt-1">התחברות</p>
        </div>
        
        <div class="space-y-4">
            <input id="emailInput" type="email" placeholder="אימייל" 
                   class="w-full p-3 border rounded-lg text-right">
            <input id="passwordInput" type="password" placeholder="סיסמה" 
                   class="w-full p-3 border rounded-lg text-right">
            
            <div class="flex flex-col space-y-4">
                <!-- כפתור התחברות רגיל -->
                <button id="loginBtn" 
                        class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600">
                    התחבר
                </button>

                <!-- כפתור הרשמה -->
                <button id="registerBtn" 
                        class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600">
                    הירשם
                </button>

                <!-- כפתור התחברות עם גוגל -->
                <button id="googleLoginBtn" 
                        class="w-full bg-purple-700 text-white py-3 rounded-lg hover:bg-purple-800 flex items-center justify-center gap-4 font-semibold">
                    התחבר עם
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" 
                         alt="Google logo" 
                         class="w-7 h-7">
                </button>
                
                <div class="text-center mt-4">
                    <button id="resetPasswordBtn" 
                            class="text-gray-800 hover:text-gray-600 text-sm font-semibold"
                            onclick="resetPassword()">
                        שכחת סיסמה?
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- קונטיינר אפליקציה -->
    <div id="appContainer" class="container mx-auto max-w-md bg-white rounded-xl shadow-2xl p-6 hidden">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">מנהל כספים</h1>
            <p id="userEmail" class="text-sm text-gray-500 mt-1"></p>
            <button onclick="logout()" 
                    class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded-lg text-sm">
                התנתק
            </button>
        </div>
        
        <div class="mb-6">
            <div id="balance" class="text-center text-4xl font-extrabold text-green-600">0 ₪</div>
        </div>

        <div class="flex space-x-4 mb-6">
            <button id="incomeBtn" onclick="openModal('income')" class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition">
                <span class="text-xl">➕ הכנסה</span>
            </button>
            <button id="expenseBtn" onclick="openModal('expense')" class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition">
                <span class="text-xl">➖ הוצאה</span>
            </button>
        </div>

        <div class="bg-gray-100 rounded-lg p-4">
            <h2 class="text-xl font-bold mb-4 text-gray-700">היסטוריית תנועות</h2>
            <ul id="transactions" class="space-y-2 max-h-64 overflow-y-auto"></ul>
        </div>

        <canvas id="chartArea" class="mt-6 w-full"></canvas>
    </div>

    <!-- מודאל עסקה -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-96">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4"></h2>
            <input id="amountInput" type="number" placeholder="סכום" 
                   class="w-full p-3 border rounded-lg mb-4 text-right">
            <input id="descriptionInput" type="text" placeholder="תיאור (אופציונלי)" 
                   class="w-full p-3 border rounded-lg mb-4 text-right">
            <div class="flex space-x-4">
                <button onclick="saveTransaction()" 
                        class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
                    שמור
                </button>
                <button onclick="closeModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400">
                    ביטול
                </button>
            </div>
        </div>
    </div>

    <!-- מודאל איפוס סיסמה -->
    <div id="resetPasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl w-96">
            <h2 class="text-2xl font-bold mb-4">איפוס סיסמה</h2>
            <p class="text-gray-600 mb-4">הזן את כתובת הדוא"ל שלך ונשלח לך קישור לאיפוס הסיסמה</p>
            <input type="email" 
                   id="resetEmail" 
                   class="w-full p-3 border rounded-lg mb-4 text-right" 
                   placeholder="כתובת דוא״ל">
            <div class="flex space-x-4">
                <button onclick="closeResetModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400">
                    ביטול
                </button>
                <button onclick="sendResetEmail()" 
                        class="flex-1 bg-black text-white py-3 rounded-lg hover:bg-gray-800">
                    שלח קישור
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut, 
            onAuthStateChanged,
            sendPasswordResetEmail
        } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtlCl3Mnxr22HpHe3QaHwizNL4VNOdlGc",
            authDomain: "finnance-manger.firebaseapp.com",
            projectId: "finnance-manger",
            storageBucket: "finnance-manger.firebasestorage.app",
            messagingSenderId: "341045979158",
            appId: "1:341045979158:web:57c180406d33d5b6a76d37",
            measurementId: "G-G1HVDTTG6K"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null;
        let balance = 0;
        let transactions = [];
        let chart = null;

        // Reset Password Functions
        window.resetPassword = () => {
            document.getElementById('resetPasswordModal').classList.remove('hidden');
            document.getElementById('resetPasswordModal').classList.add('flex');
        };

        window.closeResetModal = () => {
            document.getElementById('resetPasswordModal').classList.add('hidden');
            document.getElementById('resetPasswordModal').classList.remove('flex');
            document.getElementById('resetEmail').value = '';
        };

        window.sendResetEmail = async () => {
            const email = document.getElementById('resetEmail').value;
            
            if (!email) {
                alert('נא להזין כתובת דוא"ל');
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                alert('קישור לאיפוס סיסמה נשלח לדוא"ל שלך');
                closeResetModal();
            } catch (error) {
                console.error('שגיאה באיפוס סיסמה:', error);
                alert('שגיאה באיפוס סיסמה. נא לנסות שוב מאוחר יותר.');
            }
        };

        // Login with Google
        window.loginWithGoogle = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                currentUser = result.user;
                switchToApp();
                
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (!userDoc.exists()) {
                    await initializeUserData();
                } else {
                    await loadUserData();
                }
            } catch (error) {
                console.error('Google login error:', error);
                alert('שגיאה בהתחברות עם Google: ' + error.message);
            }
        };

        // Regular login
        window.login = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                alert('אנא הזן אימייל וסיסמה');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                switchToApp();
                await loadUserData();
            } catch (error) {
                console.error('Login error:', error);
                alert('שגיאה בהתחברות: ' + error.message);
            }
        };

        // Register
        window.register = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                alert('אנא הזן אימייל וסיסמה');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                switchToApp();
                await initializeUserData();
            } catch (error) {
                console.error('Registration error:', error);
                alert('שגיאה בהרשמה: ' + error.message);
            }
        };

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
                switchToLogin();
            } catch (error) {
                console.error('Logout error:', error);
                alert('שגיאה בהתנתקות: ' + error.message);
            }
        };

        // Initialize user data
        async function initializeUserData() {
            try {
                await setDoc(doc(db, 'users', currentUser.uid), {
                    balance: 0,
                    transactions: []
                });
                updateUI(0, []);
            } catch (error) {
                console.error('Error initializing user data:', error);
                alert('שגיאה באתחול נתוני משתמש: ' + error.message);
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const docSnap = await getDoc(doc(db, 'users', currentUser.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateUI(data.balance || 0, data.transactions || []);
                } else {
                    await initializeUserData();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('שגיאה בטעינת נתונים: ' + error.message);
            }
        }

        // Save user data
        async function saveUserData(newBalance, newTransactions) {
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    balance: newBalance,
                    transactions: newTransactions
                });
            } catch (error) {
                console.error('Error saving user data:', error);
                alert('שגיאה בשמירת נתונים: ' + error.message);
            }
        }

        // UI functions
        window.switchToLogin = () => {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        window.switchToApp = () => {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        window.openModal = (type) => {
            const modal = document.getElementById('transactionModal');
            const titleEl = document.getElementById('modalTitle');
            const amountInput = document.getElementById('amountInput');
            const descriptionInput = document.getElementById('descriptionInput');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            amountInput.value = '';
            descriptionInput.value = '';

            titleEl.textContent = type === 'income' ? 'הוספת הכנסה' : 'הוספת הוצאה';
            titleEl.className = `text-2xl font-bold mb-4 ${type === 'income' ? 'text-green-600' : 'text-red-600'}`;

            modal.dataset.type = type;
        };

        window.closeModal = () => {
            document.getElementById('transactionModal').classList.replace('flex', 'hidden');
        };

        window.saveTransaction = async () => {
            const amount = parseFloat(document.getElementById('amountInput').value);
            const description = document.getElementById('descriptionInput').value.trim();
            const type = document.getElementById('transactionModal').dataset.type;

            if (!amount) {
                alert('אנא הזן סכום');
                return;
            }

            if (type === 'expense' && amount > balance) {
                alert('אין מספיק כסף בחשבון');
                return;
            }

            const transaction = {
                type,
                amount,
                description: description || null,
                date: new Date().toISOString()
            };

            transactions.unshift(transaction);
            balance += type === 'income' ? amount : -amount;

            updateUI(balance, transactions);
            await saveUserData(balance, transactions);
            closeModal();
        };

        function updateUI(newBalance, newTransactions) {
            balance = newBalance;
            transactions = newTransactions;

            document.getElementById('balance').textContent = `${balance} ₪`;
            
            document.getElementById('transactions').innerHTML = transactions.map(t => `
                <li class="flex justify-between p-2 rounded-lg ${t.type === 'income' ? 'bg-green-100' : 'bg-red-100'}">
                    <div class="flex flex-col">
                        <span class="text-gray-800">${t.description || ''}</span>
                        <span class="text-xs text-gray-500">${new Date(t.date).toLocaleString()}</span>
                    </div>
                    <span class="${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${t.type === 'income' ? '+' : '-'} ${t.amount} ₪
                    </span>
                </li>
            `).join('');

            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('chartArea').getContext('2d');
            
            if (chart) chart.destroy();

            const incomeData = transactions
                .filter(t => t.type === 'income')
                .map(t => t.amount);

            const expenseData = transactions
                .filter(t => t.type === 'expense')
                .map(t => t.amount);

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['הכנסות', 'הוצאות'],
                    datasets: [{
                        data: [
                            incomeData.reduce((a, b) => a + b, 0),
                            expenseData.reduce((a, b) => a + b, 0)
                        ],
                        backgroundColor: ['#10B981', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Add event listeners
        document.getElementById('loginBtn').addEventListener('click', window.login);
        document.getElementById('registerBtn').addEventListener('click', window.register);
        document.getElementById('googleLoginBtn').addEventListener('click', window.loginWithGoogle);

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                switchToApp();
                loadUserData();
            } else {
                switchToLogin();
            }
        });
    </script>
</body>
</html>
