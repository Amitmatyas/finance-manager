<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×× ×”×œ ×›×¡×¤×™× - ×××ª ×¢××™×ª ××˜×™××¡</title>
    <!-- ×¢×“×›×•×Ÿ ×œ×’×¨×¡×” ×”××•×“×•×œ×¨×™×ª ×©×œ Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtlCl3Mnxr22HpHe3QaHwizNL4VNOdlGc",
            authDomain: "finnance-manger.firebaseapp.com",
            projectId: "finnance-manger",
            storageBucket: "finnance-manger.firebasestorage.app",
            messagingSenderId: "341045979158",
            appId: "1:341045979158:web:57c180406d33d5b6a76d37",
            measurementId: "G-G1HVDTTG6K"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null;
        let balance = 0;
        let transactions = [];
        let chart = null;

        // Login with Google
        window.loginWithGoogle = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                currentUser = result.user;
                switchToApp();
                
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (!userDoc.exists()) {
                    await initializeUserData();
                } else {
                    await loadUserData();
                }
            } catch (error) {
                console.error('Google login error:', error);
                alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×¢× Google: ' + error.message);
            }
        };

        // Regular login
        window.login = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                alert('×× × ×”×–×Ÿ ××™××™×™×œ ×•×¡×™×¡××”');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                switchToApp();
                await loadUserData();
            } catch (error) {
                console.error('Login error:', error);
                alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + error.message);
            }
        };

        // Register
        window.register = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                alert('×× × ×”×–×Ÿ ××™××™×™×œ ×•×¡×™×¡××”');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                switchToApp();
                await initializeUserData();
            } catch (error) {
                console.error('Registration error:', error);
                alert('×©×’×™××” ×‘×”×¨×©××”: ' + error.message);
            }
        };

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
                switchToLogin();
            } catch (error) {
                console.error('Logout error:', error);
                alert('×©×’×™××” ×‘×”×ª× ×ª×§×•×ª: ' + error.message);
            }
        };

        // Initialize user data
        async function initializeUserData() {
            try {
                await setDoc(doc(db, 'users', currentUser.uid), {
                    balance: 0,
                    transactions: []
                });
                updateUI(0, []);
            } catch (error) {
                console.error('Error initializing user data:', error);
                alert('×©×’×™××” ×‘××ª×—×•×œ × ×ª×•× ×™ ××©×ª××©: ' + error.message);
            }
        }

        // Load user data
        async function loadUserData() {
            try {
                const docSnap = await getDoc(doc(db, 'users', currentUser.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updateUI(data.balance || 0, data.transactions || []);
                } else {
                    await initializeUserData();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        // Save user data
        async function saveUserData(newBalance, newTransactions) {
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    balance: newBalance,
                    transactions: newTransactions
                });
            } catch (error) {
                console.error('Error saving user data:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª × ×ª×•× ×™×: ' + error.message);
            }
        }

        // UI functions
        function switchToLogin() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        function switchToApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        window.openModal = (type) => {
            const modal = document.getElementById('transactionModal');
            const titleEl = document.getElementById('modalTitle');
            const amountInput = document.getElementById('amountInput');
            const descriptionInput = document.getElementById('descriptionInput');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            amountInput.value = '';
            descriptionInput.value = '';

            titleEl.textContent = type === 'income' ? '×”×•×¡×¤×ª ×”×›× ×¡×”' : '×”×•×¡×¤×ª ×”×•×¦××”';
            titleEl.className = type === 'income' ? 'text-green-600' : 'text-red-600';

            modal.dataset.type = type;
        };

        window.closeModal = () => {
            document.getElementById('transactionModal').classList.replace('flex', 'hidden');
        };

        window.saveTransaction = async () => {
            const amount = parseFloat(document.getElementById('amountInput').value);
            const description = document.getElementById('descriptionInput').value.trim();
            const type = document.getElementById('transactionModal').dataset.type;

            if (!amount) {
                alert('×× × ×”×–×Ÿ ×¡×›×•×');
                return;
            }

            if (type === 'expense' && amount > balance) {
                alert('××™×Ÿ ××¡×¤×™×§ ×›×¡×£ ×‘×—×©×‘×•×Ÿ');
                return;
            }

            const transaction = {
                type,
                amount,
                description: description || null,
                date: new Date().toISOString()
            };

            transactions.unshift(transaction);
            balance += type === 'income' ? amount : -amount;

            updateUI(balance, transactions);
            await saveUserData(balance, transactions);
            closeModal();
        };

        function updateUI(newBalance, newTransactions) {
            balance = newBalance;
            transactions = newTransactions;

            document.getElementById('balance').textContent = `${balance} â‚ª`;
            
            document.getElementById('transactions').innerHTML = transactions.map(t => `
                <li class="flex justify-between p-2 rounded-lg ${t.type === 'income' ? 'bg-green-100' : 'bg-red-100'}">
                    <div class="flex flex-col">
                        <span class="text-gray-800">${t.description || ''}</span>
                        <span class="text-xs text-gray-500">${new Date(t.date).toLocaleString()}</span>
                    </div>
                    <span class="${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${t.type === 'income' ? '+' : '-'} ${t.amount} â‚ª
                    </span>
                </li>
            `).join('');

            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('chartArea').getContext('2d');
            
            if (chart) chart.destroy();

            const incomeData = transactions
                .filter(t => t.type === 'income')
                .map(t => t.amount);

            const expenseData = transactions
                .filter(t => t.type === 'expense')
                .map(t => t.amount);

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['×”×›× ×¡×•×ª', '×”×•×¦××•×ª'],
                    datasets: [{
                        data: [
                            incomeData.reduce((a, b) => a + b, 0),
                            expenseData.reduce((a, b) => a + b, 0)
                        ],
                        backgroundColor: ['#10B981', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                switchToApp();
                loadUserData();
            } else {
                switchToLogin();
            }
        });

        // Expose functions to window
        window.currentUser = currentUser;
        window.balance = balance;
        window.transactions = transactions;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
</head>
<!-- ×©××¨ ×”-HTML × ×©××¨ ×–×”×” -->
