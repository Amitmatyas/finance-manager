<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×× ×”×œ ×›×¡×¤×™× - ×××ª ×¢××™×ª ××˜×™××¡</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’°</text></svg>">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <!-- ×§×•× ×˜×™×™× ×¨ ×”×ª×—×‘×¨×•×ª -->
    <div id="loginContainer" class="container mx-auto max-w-md bg-white rounded-xl shadow-2xl p-6">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">×× ×”×œ ×›×¡×¤×™×</h1>
            <p class="text-sm text-gray-500 mt-1">×”×ª×—×‘×¨×•×ª</p>
        </div>
        
        <div class="space-y-4">
            <input id="emailInput" type="email" placeholder="××™××™×™×œ" 
                   class="w-full p-3 border rounded-lg text-right">
            <input id="passwordInput" type="password" placeholder="×¡×™×¡××”" 
                   class="w-full p-3 border rounded-lg text-right">
            
            <div class="flex flex-col space-y-4">
                <button id="loginBtn" 
                        class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
                    ×”×ª×—×‘×¨
                </button>
                <button id="registerBtn" 
                        class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600">
                    ×”×™×¨×©×
                </button>
                <button id="googleLoginBtn" 
                        class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 flex items-center justify-center">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google-icon.svg" alt="Google logo" class="w-6 h-6 mr-2">
                    ×”×ª×—×‘×¨ ×¢× ×’×•×’×œ
                </button>
            </div>
        </div>
    </div>

    <!-- ×§×•× ×˜×™×™× ×¨ ××¤×œ×™×§×¦×™×” -->
    <div id="appContainer" class="container mx-auto max-w-md bg-white rounded-xl shadow-2xl p-6 hidden">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">×× ×”×œ ×›×¡×¤×™×</h1>
            <p id="userEmail" class="text-sm text-gray-500 mt-1"></p>
            <button onclick="logout()" 
                    class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded-lg text-sm">
                ×”×ª× ×ª×§
            </button>
        </div>
        
        <div class="mb-6">
            <div id="balance" class="text-center text-4xl font-extrabold text-green-600">0 â‚ª</div>
        </div>

        <div class="flex space-x-4 mb-6">
            <button id="incomeBtn" class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition">
                <span class="text-xl">â• ×”×›× ×¡×”</span>
            </button>
            <button id="expenseBtn" class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition">
                <span class="text-xl">â– ×”×•×¦××”</span>
            </button>
        </div>

        <div class="bg-gray-100 rounded-lg p-4">
            <h2 class="text-xl font-bold mb-4 text-gray-700">×”×™×¡×˜×•×¨×™×™×ª ×ª× ×•×¢×•×ª</h2>
            <ul id="transactions" class="space-y-2 max-h-64 overflow-y-auto"></ul>
        </div>

        <canvas id="chartArea" class="mt-6 w-full"></canvas>

        <!-- ××•×“××œ ×¢×¡×§×” -->
        <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 w-96">
                <h2 id="modalTitle" class="text-2xl font-bold mb-4"></h2>
                <input id="amountInput" type="number" placeholder="×¡×›×•×" 
                       class="w-full p-3 border rounded-lg mb-4 text-right">
                <input id="descriptionInput" type="text" placeholder="×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)" 
                       class="w-full p-3 border rounded-lg mb-4 text-right">
                <div class="flex space-x-4">
                    <button onclick="saveTransaction()" 
                            class="flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
                        ×©××•×¨
                    </button>
                    <button onclick="closeModal()" 
                            class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtlCl3Mnxr22HpHe3QaHwizNL4VNOdlGc",
            authDomain: "finnance-manger.firebaseapp.com",
            projectId: "finnance-manger",
            storageBucket: "finnance-manger.firebasestorage.app",
            messagingSenderId: "341045979158",
            appId: "1:341045979158:web:57c180406d33d5b6a76d37",
            measurementId: "G-G1HVDTTG6K"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ×”×•×¡×¤×ª ×¡×¤×§ ×›× ×™×¡×” ×©×œ ×’×•×’×œ
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // ×¤×•× ×§×¦×™×™×ª ×”×ª×—×‘×¨×•×ª ×¢× ×’×•×’×œ
        function loginWithGoogle() {
            auth.signInWithPopup(googleProvider)
                .then((result) => {
                    console.log('×”×ª×—×‘×¨×•×ª ×¢× ×’×•×’×œ ×”×¦×œ×™×—×”:', result.user);
                    currentUser = result.user;
                    switchToApp();
                    
                    // ×‘×“×™×§×” ×× ×”××©×ª××© ×§×™×™× ×›×‘×¨ ×‘××¡×“ ×”× ×ª×•× ×™×
                    const userRef = db.collection('users').doc(currentUser.uid);
                    userRef.get().then((doc) => {
                        if (!doc.exists) {
                            // ×× ×”××©×ª××© ×œ× ×§×™×™×, ×™×¦×™×¨×ª ××¡××š ×—×“×©
                            initializeUserData();
                        } else {
                            // ×× ×”××©×ª××© ×§×™×™×, ×˜×¢×™× ×ª ×”× ×ª×•× ×™×
                            loadUserData();
                        }
                    });
                })
                .catch((error) => {
                    console.error('×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×¢× ×’×•×’×œ:', error);
                    
                    // ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
                    switch(error.code) {
                        case 'auth/account-exists-with-different-credential':
                            alert('×§×™×™× ×—×©×‘×•×Ÿ ×¢× ××•×ª×” ×›×ª×•×‘×ª ×“×•×"×œ ×‘×¡×¤×§ ××—×¨');
                            break;
                        case 'auth/popup-blocked':
                            alert('×”×—×œ×•×Ÿ × ×—×¡×. ×× × ×”×¤×¢×œ ×—×œ×•× ×•×ª ××•×§×¤×¦×™×');
                            break;
                        case 'auth/popup-closed-by-user':
                            alert('×‘×™×˜×œ×ª ××ª ×ª×”×œ×™×š ×”×”×ª×—×‘×¨×•×ª');
                            break;
                        default:
                            alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + error.message);
                    }
                });
        }

        // ×¤×•× ×§×¦×™×™×ª ×”×ª×—×‘×¨×•×ª ×¡×˜× ×“×¨×˜×™×ª
        function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                alert('×× × ×”×–×Ÿ ××™××™×™×œ ×•×¡×™×¡××”');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('×”×ª×—×‘×¨×•×ª ×”×¦×œ×™×—×”:', userCredential.user);
                    currentUser = userCredential.user;
                    switchToApp();
                    loadUserData();
                })
                .catch((error) => {
                    console.error('×©×’×™××ª ×”×ª×—×‘×¨×•×ª:', error);
                    
                    switch(error.code) {
                        case 'auth/invalid-email':
                            alert('×›×ª×•×‘×ª ×”××™××™×™×œ ×©×’×•×™×”');
                            break;
                        case 'auth/user-disabled':
                            alert('×”××©×ª××© × ×—×¡×');
                            break;
                        case 'auth/user-not-found':
                            alert('××©×ª××© ×œ× × ××¦×');
                            break;
                        case 'auth/wrong-password':
                            alert('×¡×™×¡××” ×©×’×•×™×”');
                            break;
                        default:
                            alert('×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ' + error.message);
                    }
                });
        }

        // ×¤×•× ×§×¦×™×™×ª ×”×¨×©××”
        function register() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            // ×‘×“×™×§×•×ª ×ª×§×™× ×•×ª ×§×œ×˜
            if (!email || !password) {
                alert('×× × ×”×–×Ÿ ××™××™×™×œ ×•×¡×™×¡××”');
                return;
            }

            if (password.length < 6) {
                alert('×”×¡×™×¡××” ×¦×¨×™×›×” ×œ×”×™×•×ª ×‘××•×¨×š ×©×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('×”×¨×©××” ×”×¦×œ×™×—×”:', userCredential.user);
                    currentUser = userCredential.user;
                    switchToApp();
                    initializeUserData();
                })
                .catch((error) => {
                    console.error('×©×’×™××ª ×”×¨×©××”:', error);
                    
                    // ×˜×™×¤×•×œ ××¤×•×¨×˜ ×‘×©×’×™××•×ª
                    switch(error.code) {
                        case 'auth/email-already-in-use':
                            alert('×›×ª×•×‘×ª ×”××™××™×™×œ ×›×‘×¨ ×‘×©×™××•×©');
                            break;
                        case 'auth/invalid-email':
                            alert('×›×ª×•×‘×ª ×”××™××™×™×œ ×©×’×•×™×”');
                            break;
                        case 'auth/operation-not-allowed':
                            alert('×”×¨×©××” ×œ× ×××•×¤×©×¨×ª');
                            break;
                        case 'auth/weak-password':
                            alert('×”×¡×™×¡××” ×—×œ×©×” ××“×™');
                            break;
                        default:
                            alert('×©×’×™××ª ×”×¨×©××”: ' + error.message);
                    }
                });
        }

        // ×¤×•× ×§×¦×™×™×ª ×”×ª× ×ª×§×•×ª
        function logout() {
            auth.signOut().then(() => {
                switchToLogin();
            }).catch((error) => {
                console.error('×©×’×™××ª ×”×ª× ×ª×§×•×ª:', error);
            });
        }

        // ×”×—×œ×¤×ª ××¡×›×™×
        function switchToLogin() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        function switchToApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        // ××ª×—×•×œ × ×ª×•× ×™ ××©×ª××©
        function initializeUserData() {
            db.collection('users').doc(currentUser.uid).set({
                balance: 0,
                transactions: []
            });
            updateUI(0, []);
        }

        // ×˜×¢×™× ×ª × ×ª×•× ×™ ××©×ª××©
        function loadUserData() {
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        updateUI(data.balance || 0, data.transactions || []);
                    } else {
                        initializeUserData();
                    }
                })
                .catch((error) => {
                    console.error('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×:', error);
                });
        }

        // ×©××™×¨×ª × ×ª×•× ×™ ××©×ª××©
        function saveUserData(newBalance, newTransactions) {
            db.collection('users').doc(currentUser.uid).update({
                balance: newBalance,
                transactions: newTransactions
            });
        }

        // ×¤×ª×™×—×ª ××•×“××œ ×¢×¡×§×”
        function openModal(type) {
            const modal = document.getElementById('transactionModal');
            const titleEl = document.getElementById('modalTitle');
            const amountInput = document.getElementById('amountInput');
            const descriptionInput = document.getElementById('descriptionInput');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            amountInput.value = '';
            descriptionInput.value = '';

            if (type === 'income') {
                titleEl.textContent = '×”×•×¡×¤×ª ×”×›× ×¡×”';
                titleEl.classList.remove('text-red-600');
                titleEl.classList.add('text-green-600');
            } else {
                titleEl.textContent = '×”×•×¡×¤×ª ×”×•×¦××”';
                titleEl.classList.remove('text-green-600');
                titleEl.classList.add('text-red-600');
            }

            modal.dataset.type = type;
        }

        // ×¡×’×™×¨×ª ××•×“××œ
        function closeModal() {
            const modal = document.getElementById('transactionModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        // ×©××™×¨×ª ×¢×¡×§×”
        function saveTransaction() {
            const amountInput = document.getElementById('amountInput');
            const descriptionInput = document.getElementById('descriptionInput');
            const type = document.getElementById('transactionModal').dataset.type;

            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value.trim();

            if (!amount) {
                alert('×× × ×”×–×Ÿ ×¡×›×•×');
                return;
            }

            if (type === 'expense' && amount > balance) {
                alert('××™×Ÿ ××¡×¤×™×§ ×›×¡×£ ×‘×—×©×‘×•×Ÿ');
                return;
            }

            const transaction = {
                type,
                amount,
                description: description || null,
                date: new Date().toISOString()
            };

            transactions.unshift(transaction);
            balance += type === 'income' ? amount : -amount;

            updateUI(balance, transactions);
            saveUserData(balance, transactions);
            closeModal();
        }

        // ×¢×“×›×•×Ÿ ×××©×§ ××©×ª××©
        function updateUI(newBalance, newTransactions) {
            balance = newBalance;
            transactions = newTransactions;

            const balanceEl = document.getElementById('balance');
            const transactionsEl = document.getElementById('transactions');

            balanceEl.textContent = `${balance} â‚ª`;
            
            transactionsEl.innerHTML = transactions.map(t => `
                <li class="flex justify-between p-2 rounded-lg ${t.type === 'income' ? 'bg-green-100' : 'bg-red-100'}">
                    <div class="flex flex-col">
                        <span class="text-gray-800">${t.description || ''}</span>
                        <span class="text-xs text-gray-500">${new Date(t.date).toLocaleString()}</span>
                    </div>
                    <span class="${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${t.type === 'income' ? '+' : '-'} ${t.amount} â‚ª
                    </span>
                </li>
            `).join('');

            updateChart();
        }

        // ×¢×“×›×•×Ÿ ×’×¨×£
        function updateChart() {
            const ctx = document.getElementById('chartArea').getContext('2d');
            
            if (chart) chart.destroy();

            const incomeData = transactions
                .filter(t => t.type === 'income')
                .map(t => t.amount);

            const expenseData = transactions
                .filter(t => t.type === 'expense')
                .map(t => t.amount);

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['×”×›× ×¡×•×ª', '×”×•×¦××•×ª'],
                    datasets: [{
                        data: [
                            incomeData.reduce((a, b) => a + b, 0),
                            expenseData.reduce((a, b) => a + b, 0)
                        ],
                        backgroundColor: ['#10B981', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ×××–×™×Ÿ ×œ××¦×‘ ×”×ª×—×‘×¨×•×ª
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                switchToApp();
                loadUserData();
            } else {
                switchToLogin();
            }
        });

        // ×××–×™× ×™ ××™×¨×•×¢×™×
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('googleLoginBtn').addEventListener('click', loginWithGoogle);
        document.getElementById('incomeBtn').addEventListener('click', () => openModal('income'));
        document.getElementById('expenseBtn').addEventListener('click', () => openModal('expense'));
    </script>
</body>
</html>
